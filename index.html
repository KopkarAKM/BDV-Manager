<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BDV Manager Pro - Adaro KM</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; -webkit-tap-highlight-color: transparent; }
        
        /* Typography Utility */
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94A3B8; }

        /* Toast Animation */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }

        /* Tab Transitions */
        .tab-btn { transition: all 0.2s ease; }
        .tab-btn.active { background-color: #2563EB; color: white; border-color: #2563EB; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3); }
        .tab-btn.inactive { background-color: white; color: #64748B; border: 1px solid #E2E8F0; }
        .tab-btn.inactive:hover { background-color: #F1F5F9; color: #334155; }

        /* Print Styling */
        @media print {
            @page { size: A4; margin: 10mm; }
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            .doc-container { display: none; }
            .doc-container.active-doc { display: block !important; position: absolute; left: 0; top: 0; width: 100%; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; background: white; }
            .no-print { display: none !important; }
            .voucher-box { border: 2px solid #000; padding: 25px; font-family: 'Times New Roman', serif; background: white; min-height: 98vh; }
            table, th, td { border-color: #000 !important; }
        }
        
        #loading-overlay { background-color: rgba(255, 255, 255, 0.8); backdrop-filter: blur(4px); }
        .glass-nav { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-top: 1px solid rgba(0,0,0,0.05); }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- TOAST NOTIFICATION CONTAINER -->
    <div id="toast-container" class="fixed top-5 right-5 z-[70] flex flex-col gap-3"></div>

    <!-- Loading -->
    <div id="loading-overlay" class="hidden fixed inset-0 z-[60] flex items-center justify-center flex-col transition-opacity duration-300">
        <div class="relative">
            <div class="w-16 h-16 border-4 border-slate-200 border-t-blue-600 rounded-full animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center text-blue-600 text-xl font-bold">A</div>
        </div>
        <p id="loading-text" class="mt-4 text-slate-600 font-medium animate-pulse">Menghubungkan...</p>
    </div>

    <!-- DETAIL MODAL -->
    <div id="detail-modal" class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-slate-900/40 backdrop-blur-sm p-0 sm:p-4 transition-all">
        <div class="bg-white w-full sm:max-w-lg rounded-t-2xl sm:rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh] animate-slide-up">
            <div class="bg-white px-6 py-4 flex justify-between items-center border-b border-slate-100 sticky top-0 z-10">
                <div><h3 class="font-bold text-lg text-slate-800">Rincian Transaksi</h3><p class="text-xs text-slate-500 font-mono" id="modal-id-display">Loading...</p></div>
                <button onclick="closeDetail()" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 hover:bg-slate-200 text-slate-600 transition"><i class="ph ph-x text-lg"></i></button>
            </div>
            <div class="p-6 overflow-y-auto flex-1 space-y-5">
                <div class="flex justify-between items-center bg-blue-50 p-5 rounded-2xl border border-blue-100">
                    <div class="text-sm text-blue-800 font-medium">Total Nominal</div>
                    <div class="text-2xl font-bold text-blue-700 tracking-tight" id="modal-total">Rp 0</div>
                </div>
                <div class="space-y-3 text-sm bg-slate-50 p-4 rounded-xl border border-slate-100">
                    <div class="flex justify-between"><span class="text-slate-500">Tanggal</span><span class="font-medium text-slate-800" id="modal-date"></span></div>
                    <div class="flex justify-between"><span class="text-slate-500">Penerima</span><span class="font-medium text-slate-800 text-right" id="modal-paid"></span></div>
                    <div class="flex justify-between"><span class="text-slate-500">Metode</span><span class="font-medium text-slate-800" id="modal-method"></span></div>
                </div>
                <div>
                    <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Item Pembayaran</h4>
                    <div id="modal-rows" class="space-y-0 divider-y divider-slate-100"></div>
                </div>
            </div>
            <div class="p-4 border-t border-slate-100 bg-white flex gap-3">
                <button onclick="closeDetail()" class="flex-1 py-3 text-slate-600 font-medium hover:bg-slate-50 rounded-xl transition border border-transparent">Tutup</button>
                <button id="modal-print-btn" class="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg hover:bg-blue-700 transition flex items-center justify-center gap-2 transform active:scale-95"><i class="ph ph-printer text-lg"></i> Cetak Dokumen</button>
            </div>
        </div>
    </div>

    <!-- HEADER DESKTOP -->
    <header class="hidden md:flex bg-white border-b border-slate-200 h-18 items-center px-8 justify-between z-10 sticky top-0 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-blue-200">A</div>
            <div><h1 class="font-bold text-slate-800 leading-tight text-lg">BDV Manager</h1><p class="text-xs text-slate-500 font-medium">Adaro Karya Mandiri</p></div>
        </div>
        <div class="flex bg-slate-100 p-1 rounded-xl">
            <button onclick="switchTab('dashboard')" id="desk-nav-dashboard" class="px-5 py-2 rounded-lg text-sm font-medium transition-all">Dashboard</button>
            <button onclick="switchTab('input')" id="desk-nav-input" class="px-5 py-2 rounded-lg text-sm font-medium transition-all">Input Baru</button>
            <button onclick="switchTab('list')" id="desk-nav-list" class="px-5 py-2 rounded-lg text-sm font-medium transition-all">Data BDV</button>
        </div>
        <div class="flex items-center gap-2 border border-slate-200 bg-white px-3 py-1.5 rounded-full shadow-sm">
            <span id="conn-status" class="w-2.5 h-2.5 rounded-full bg-yellow-500 animate-pulse"></span>
            <span id="conn-text" class="text-xs font-semibold text-slate-600">Menunggu...</span>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto overflow-x-hidden bg-slate-50 pb-24 md:pb-12 relative">
        
        <!-- DASHBOARD -->
        <section id="view-dashboard" class="max-w-7xl mx-auto p-4 md:p-8 space-y-8 fade-in">
            <div class="md:hidden flex justify-between items-center mb-4"><div><h1 class="text-2xl font-bold text-slate-800">Dashboard</h1><p class="text-xs text-slate-500">Ringkasan Keuangan</p></div><div class="w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-bold">A</div></div>
            
            <div class="flex justify-between items-center bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-50 p-2.5 rounded-xl text-blue-600"><i class="ph ph-calendar text-xl"></i></div>
                    <div>
                        <label class="text-xs text-slate-400 font-bold uppercase block">Periode Laporan</label>
                        <input type="month" id="dashboard-filter-month" onchange="updateDashboard()" class="text-sm font-bold bg-transparent outline-none text-slate-700 cursor-pointer hover:text-blue-600 transition">
                    </div>
                </div>
                <button onclick="resetDashboardFilter()" class="text-xs font-bold text-slate-500 hover:text-blue-600 px-4 py-2 bg-slate-50 hover:bg-blue-50 rounded-lg transition">Reset Filter</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                <div class="bg-gradient-to-br from-blue-600 to-indigo-700 p-6 rounded-3xl shadow-xl shadow-blue-100 text-white relative overflow-hidden">
                    <div class="absolute right-0 top-0 opacity-10 transform translate-x-2 -translate-y-2"><i class="ph ph-wallet text-9xl"></i></div>
                    <p class="text-blue-100 text-xs font-medium mb-1 uppercase tracking-wider">Total Pengeluaran</p>
                    <h2 class="text-3xl font-bold tracking-tight" id="stat-total-amount">Rp 0</h2>
                </div>
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 flex flex-col justify-center hover:shadow-md transition">
                    <div class="flex justify-between items-start">
                        <div><p class="text-slate-400 text-xs font-bold uppercase mb-1">Jumlah Dokumen</p><h2 class="text-3xl font-bold text-slate-800" id="stat-total-docs">0</h2></div>
                        <div class="bg-green-50 text-green-600 p-2 rounded-lg"><i class="ph ph-files text-xl"></i></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 flex flex-col justify-center hover:shadow-md transition">
                    <div class="flex justify-between items-start">
                        <div><p class="text-slate-400 text-xs font-bold uppercase mb-1">Rata-rata / BDV</p><h2 class="text-2xl font-bold text-slate-800" id="stat-avg-amount">Rp 0</h2></div>
                        <div class="bg-orange-50 text-orange-600 p-2 rounded-lg"><i class="ph ph-chart-line-up text-xl"></i></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100"><h3 class="font-bold text-slate-700 mb-6 flex items-center gap-2"><i class="ph ph-chart-pie-slice text-blue-500"></i> Distribusi Akun</h3><div class="chart-container mx-auto"><canvas id="expenseChart"></canvas></div></div>
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 flex flex-col h-[400px]">
                    <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="ph ph-clock-counter-clockwise text-orange-500"></i> Aktivitas Terakhir</h3>
                    <div class="flex-1 overflow-y-auto pr-1"><ul id="recent-activity-list" class="space-y-3"></ul></div>
                </div>
            </div>
        </section>

        <!-- INPUT FORM -->
        <section id="view-input" class="hidden max-w-4xl mx-auto p-4 md:p-8 space-y-6">
            <h2 class="text-2xl font-bold text-slate-800 hidden md:block">Input Transaksi Baru</h2>
            <div class="md:hidden mb-4"><h1 class="text-2xl font-bold text-slate-800">Input Baru</h1><p class="text-xs text-slate-500">Buat voucher baru</p></div>
            
            <div class="bg-white rounded-3xl shadow-sm border border-slate-100 p-5 md:p-8 space-y-8">
                <!-- Group 1: Identitas -->
                <div class="space-y-4">
                    <h4 class="text-xs font-bold text-blue-600 uppercase tracking-wider border-b pb-2">Identitas Dokumen</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-500 uppercase flex justify-between"><span>Nomor BDV</span><span class="text-blue-500 text-[10px] cursor-pointer hover:underline" onclick="generateAutoID()">ðŸ”„ Auto-Generate</span></label>
                            <input id="in-no" type="text" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition font-medium text-blue-800 placeholder-slate-400" placeholder="Otomatis...">
                        </div>
                        <div class="space-y-1"><label class="text-xs font-bold text-slate-500 uppercase">Tanggal</label><input id="in-date" type="date" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition" onchange="generateAutoID()"></div>
                        <div class="md:col-span-2 space-y-1"><label class="text-xs font-bold text-slate-500 uppercase">Dibayar Kepada</label><input id="in-paid" type="text" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm font-medium focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="Nama Penerima / Supplier"></div>
                    </div>
                </div>

                <!-- Group 2: Metode Bayar -->
                <div class="space-y-4">
                    <h4 class="text-xs font-bold text-blue-600 uppercase tracking-wider border-b pb-2">Metode Pembayaran</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div class="space-y-1"><label class="text-xs font-bold text-slate-500 uppercase">Bank</label><input id="in-bank" type="text" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Nama Bank (Opsional)"></div>
                        <div class="space-y-1"><label class="text-xs font-bold text-slate-500 uppercase">Rekening</label><input id="in-rek" type="text" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="No. Rekening (Opsional)"></div>
                        <div class="space-y-1"><label class="text-xs font-bold text-slate-500 uppercase">No BG / Cek</label><input id="in-bg" type="text" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="-"></div>
                        <div class="space-y-1"><label class="text-xs font-bold text-slate-500 uppercase">Jenis</label><select id="in-method" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none"><option>Cash</option><option>Transfer</option><option>Cek</option></select></div>
                    </div>
                </div>

                <!-- Group 3: Rincian -->
                <div class="bg-slate-50 rounded-2xl p-5 border border-slate-200">
                    <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-slate-700">Rincian Biaya</h3><button onclick="addMsg()" class="text-xs font-bold text-white bg-blue-600 px-4 py-2 rounded-lg hover:bg-blue-700 shadow-md transition flex items-center gap-1"><i class="ph ph-plus-bold"></i> Tambah Baris</button></div>
                    <div class="overflow-x-auto"><table class="w-full min-w-[600px] text-sm"><thead class="text-left text-xs font-bold text-slate-400 uppercase tracking-wider"><tr><th class="pb-2 w-24">Kode</th><th class="pb-2">Keterangan</th><th class="pb-2 w-40 text-right">Jumlah (Rp)</th><th class="pb-2 w-10"></th></tr></thead><tbody id="in-list" class="divide-y divide-slate-200"></tbody></table></div>
                    <div class="mt-6 flex flex-col md:flex-row justify-between items-center pt-4 border-t border-slate-200"><span class="text-sm font-medium text-slate-500">Total Pembayaran</span><div class="text-right"><span class="text-3xl font-bold text-slate-800" id="in-total">Rp 0</span><div class="text-[11px] font-medium text-blue-600 italic max-w-md truncate bg-blue-50 px-2 py-1 rounded mt-1" id="in-terbilang">Nol Rupiah</div></div></div>
                </div>

                <div class="grid grid-cols-2 gap-4 pt-2">
                    <button onclick="resetForm()" class="py-3.5 border border-slate-300 rounded-xl font-bold text-slate-600 hover:bg-slate-50 transition">Reset</button>
                    <button onclick="submitData()" class="py-3.5 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 active:scale-95 transition-transform flex items-center justify-center gap-2"><i class="ph ph-floppy-disk text-lg"></i> Simpan Data</button>
                </div>
            </div>
        </section>

        <!-- LIST VIEW -->
        <section id="view-list" class="hidden max-w-6xl mx-auto p-4 md:p-8 space-y-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <h2 class="text-2xl font-bold text-slate-800">Database BDV</h2>
                <div class="flex w-full md:w-auto gap-2 bg-white p-1 rounded-xl shadow-sm border border-slate-200">
                    <div class="relative flex-1 md:flex-none"><i class="ph ph-magnifying-glass absolute left-3 top-3 text-slate-400"></i><input id="search" onkeyup="renderTable()" placeholder="Cari nomor/nama..." class="w-full md:w-64 pl-10 pr-4 py-2 bg-transparent outline-none text-sm"></div>
                    <button onclick="fetchCloudData()" class="bg-blue-50 text-blue-600 px-3 py-2 rounded-lg hover:bg-blue-100 transition"><i class="ph ph-arrows-clockwise text-lg"></i></button>
                </div>
            </div>
            <div class="md:hidden space-y-4" id="data-mobile-list"></div>
            <div class="hidden md:block bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden">
                <table class="w-full text-sm text-left"><thead class="bg-slate-50 border-b border-slate-200 text-slate-500 font-bold uppercase text-xs tracking-wider"><tr><th class="p-5">No BDV</th><th class="p-5">Tanggal</th><th class="p-5">Penerima</th><th class="p-5">Total</th><th class="p-5 text-right">Aksi</th></tr></thead><tbody id="data-desktop-body" class="divide-y divide-slate-100"></tbody></table>
            </div>
        </section>

        <!-- PRINT PREVIEW (SPLIT MODE) -->
        <section id="view-print" class="hidden max-w-5xl mx-auto pb-24 md:pb-10 p-4">
            <div class="no-print sticky top-4 z-30 bg-white/90 backdrop-blur-md p-2 rounded-2xl border border-slate-200 shadow-xl mb-8 flex flex-col md:flex-row justify-between gap-3">
                <div class="flex bg-slate-100 p-1 rounded-xl w-full md:w-auto">
                    <button onclick="switchDoc('voucher')" id="tab-voucher" class="flex-1 px-6 py-2.5 rounded-lg text-sm font-bold transition-all bg-white shadow-sm text-blue-600 ring-1 ring-black/5">Voucher</button>
                    <button onclick="switchDoc('receipt')" id="tab-receipt" class="flex-1 px-6 py-2.5 rounded-lg text-sm font-bold transition-all text-slate-500 hover:text-slate-700">Tanda Terima</button>
                </div>
                <div class="flex gap-2 w-full md:w-auto">
                    <button onclick="switchTab('list')" class="flex-1 md:flex-none px-5 py-2.5 border border-slate-300 rounded-xl hover:bg-slate-50 font-bold text-slate-600 text-sm transition">Kembali</button>
                    <button onclick="window.print()" class="flex-1 md:flex-none px-6 py-2.5 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-bold text-sm shadow-lg shadow-blue-200 flex items-center justify-center gap-2 transition transform active:scale-95"><i class="ph ph-printer text-lg"></i> Cetak</button>
                </div>
            </div>

            <div id="print-area" class="mx-auto bg-white shadow-2xl" style="max-width: 210mm; min-height: 297mm;">
                <!-- VOUCHER -->
                <div id="print-voucher-container" class="doc-container active-doc">
                    <div class="voucher-box relative p-12">
                        <div class="flex justify-between border-b-2 border-black pb-4 mb-6"><div><h1 class="text-2xl font-bold tracking-widest font-serif">BANK DISTRIBUTION VOUCHER</h1><p class="font-bold text-md mt-1 tracking-wide">Koperasi Karyawan Adaro Karya Mandiri</p></div><div class="text-right text-sm font-mono mt-2"><div class="mb-1"><span class="font-bold mr-2">NO:</span><span id="v-no"></span></div><div><span class="font-bold mr-2">TGL:</span><span id="v-date"></span></div></div></div>
                        <div class="mb-6 text-sm font-serif grid gap-1.5"><div class="grid grid-cols-[120px_1fr]"><span>BANK</span><span>: <span id="v-bank"></span></span></div><div class="grid grid-cols-[120px_1fr]"><span>REKENING</span><span>: <span id="v-rek"></span></span></div><div class="grid grid-cols-[120px_1fr]"><span>NO BG/CEK</span><span>: <span id="v-bg"></span></span></div></div>
                        <div class="border-2 border-black p-5 mb-6 text-sm font-serif"><div class="grid grid-cols-[120px_1fr] mb-4 items-start"><span class="font-bold pt-1">KEPADA</span><div class="border-b border-dotted border-black pb-1 uppercase font-bold tracking-wide" id="v-paid"></div></div><div class="grid grid-cols-[120px_1fr] mb-4 items-start"><span class="font-bold pt-1">JUMLAH</span><div class="bg-gray-100 p-2 font-bold border border-gray-400 italic tracking-wide" id="v-terbilang"></div></div><div class="grid grid-cols-[120px_1fr] items-start"><span class="font-bold pt-1">METODE</span><div class="border-b border-dotted border-black pb-1" id="v-method"></div></div></div>
                        <table class="w-full text-sm border border-black mb-10 font-serif"><thead class="bg-gray-200 font-bold border-b border-black"><tr><td class="p-2 border-r border-black w-24 text-center">KODE</td><td class="p-2 border-r border-black">KETERANGAN</td><td class="p-2 text-right w-40">JUMLAH</td></tr></thead><tbody id="v-rows"></tbody><tfoot class="font-bold border-t border-black bg-gray-100"><tr><td colspan="2" class="p-2 text-right border-r border-black">TOTAL</td><td class="p-2 text-right font-mono" id="v-total"></td></tr></tfoot></table>
                        <div class="grid grid-cols-5 gap-4 text-center text-xs font-serif pt-16"><div><p class="mb-20">Dibuat,</p><p class="border-t border-black font-bold pt-1">Administrasi</p></div><div><p class="mb-20">Diperiksa,</p><p class="border-t border-black font-bold pt-1">Staff Admin</p></div><div><p class="mb-20">Diketahui,</p><p class="border-t border-black font-bold pt-1">Manager</p></div><div><p class="mb-20">Disetujui,</p><p class="border-t border-black font-bold pt-1">Bendahara</p></div><div><p class="mb-20">Disetujui,</p><p class="border-t border-black font-bold pt-1">Ketua</p></div></div>
                    </div>
                </div>
                <!-- RECEIPT -->
                <div id="print-receipt-container" class="doc-container" style="display: none;">
                    <div class="voucher-box relative p-12">
                        <div class="flex justify-between border-b-2 border-black pb-4 mb-8"><div><h1 class="text-2xl font-bold tracking-widest font-serif">TANDA TERIMA / ARSIP</h1><p class="font-bold text-sm mt-1">Bukti Pengeluaran Kas/Bank</p></div><div class="text-right text-sm font-mono mt-2"><div class="mb-1"><span class="font-bold mr-2">REF:</span><span id="r-no"></span></div><div><span class="font-bold mr-2">TGL:</span><span id="r-date"></span></div></div></div>
                        <div class="border-2 border-black p-8 bg-slate-50/50 mb-12">
                            <div class="grid grid-cols-[140px_20px_1fr] gap-y-5 text-sm font-serif items-start">
                                <div class="font-bold pt-1">Telah Terima Dari</div><div class="text-center font-bold pt-1">:</div><div class="border-b border-black uppercase font-bold text-lg pb-1 tracking-wide">KOPERASI KARYAWAN ADARO KARYA MANDIRI</div>
                                <div class="font-bold pt-1">Uang Sejumlah</div><div class="text-center font-bold pt-1">:</div><div class="border-b border-black italic bg-white px-3 py-1 shadow-sm tracking-wide" id="r-terbilang"></div>
                                <div class="font-bold pt-2">Guna Membayar</div><div class="text-center font-bold pt-2">:</div><div class="border-b border-black pb-4 bg-white px-4 pt-4 shadow-sm min-h-[100px]"><table class="w-full text-sm border-collapse" id="r-desc-table"></table></div>
                                <div class="font-bold text-xl mt-4">TOTAL</div><div class="text-center font-bold text-xl mt-4">:</div><div class="mt-4"><div class="border-2 border-black bg-white font-bold text-xl px-6 py-2 inline-block min-w-[200px] text-right shadow-sm font-mono" id="r-total">Rp 0</div></div>
                            </div>
                        </div>
                        <div class="flex justify-between px-16 text-sm font-serif pt-10"><div class="text-center w-48"><p class="mb-24">Mengetahui,</p><p class="border-t border-black font-bold pt-1">Keuangan / Kasir</p></div><div class="text-center w-64"><p class="mb-4">................, ........................ 20...</p><p class="mb-16">Penerima,</p><p class="border-t border-black font-bold pt-1">( ............................................ )</p></div></div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- MOBILE NAV -->
    <nav class="md:hidden fixed bottom-0 w-full glass-nav pb-safe z-40 no-print border-t border-slate-200">
        <div class="flex justify-around items-center h-16">
            <button onclick="switchTab('dashboard')" id="mob-nav-dashboard" class="flex flex-col items-center justify-center w-full h-full nav-item-active"><i class="ph ph-squares-four text-2xl mb-1"></i><span class="text-[10px] font-medium">Home</span></button>
            <button onclick="switchTab('input')" id="mob-nav-input" class="flex flex-col items-center justify-center w-full h-full nav-item-inactive"><div class="bg-blue-600 rounded-2xl p-3 -mt-8 shadow-lg shadow-blue-200 border-4 border-white text-white transform transition active:scale-95"><i class="ph ph-plus text-2xl"></i></div><span class="text-[10px] font-medium mt-1">Input</span></button>
            <button onclick="switchTab('list')" id="mob-nav-list" class="flex flex-col items-center justify-center w-full h-full nav-item-inactive"><i class="ph ph-list-dashes text-2xl mb-1"></i><span class="text-[10px] font-medium">Data</span></button>
        </div>
    </nav>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbznZjY5kvBXsf7AzUbc5v7Yz23TtLz6lSGYcHHOfuPoRgbKf90qYswRWVZ0w07AxZrT-w/exec'; 
        let db = [], items = [];

        window.onload = () => { initForm(); if(SCRIPT_URL.includes('/exec')) fetchCloudData(); };

        // TOAST NOTIFICATION SYSTEM
        function showToast(msg, type='success') {
            const box = document.createElement('div');
            box.className = `toast-enter p-4 rounded-xl shadow-lg border flex items-center gap-3 min-w-[300px] bg-white ${type==='success'?'border-green-100':'border-red-100'}`;
            box.innerHTML = `
                <div class="w-8 h-8 rounded-full flex items-center justify-center ${type==='success'?'bg-green-100 text-green-600':'bg-red-100 text-red-600'}"><i class="ph ${type==='success'?'ph-check':'ph-warning'} text-lg"></i></div>
                <div><h4 class="font-bold text-sm text-slate-800">${type==='success'?'Berhasil':'Gagal'}</h4><p class="text-xs text-slate-500">${msg}</p></div>
            `;
            document.getElementById('toast-container').appendChild(box);
            setTimeout(() => { box.remove(); }, 4000);
        }

        // INPUT FORMATTING (CURRENCY MASK)
        function formatInputCurrency(input) {
            let val = input.value.replace(/\D/g, ''); // Remove non-digits
            if (val === '') { input.value = ''; return 0; }
            const num = parseInt(val, 10);
            input.value = new Intl.NumberFormat('id-ID').format(num);
            return num;
        }

        // AUTO ID
        function generateAutoID() {
            const dateInput = document.getElementById('in-date').value; if(!dateInput) return;
            const d = new Date(dateInput); const mRom = ["I","II","III","IV","V","VI","VII","VIII","IX","X","XI","XII"][d.getMonth()];
            let max = 0; db.forEach(x => { const n = parseInt(x.id.split('/')[0]); if(!isNaN(n) && n > max) max = n; });
            document.getElementById('in-no').value = `${String(max+1).padStart(2,'0')}/BDV/KOPKAR/${mRom}/${d.getFullYear()}`;
        }

        function fetchCloudData() {
            document.getElementById('loading-overlay').classList.remove('hidden');
            fetch(SCRIPT_URL).then(res=>res.json()).then(d=>{ db=d; document.getElementById('loading-overlay').classList.add('hidden'); document.getElementById('conn-status').classList.replace('bg-yellow-500','bg-green-500'); document.getElementById('conn-text').innerText="Online"; renderTable(); updateDashboard(); if(document.getElementById('in-no').value==="") generateAutoID(); }).catch(()=>{ document.getElementById('loading-overlay').classList.add('hidden'); document.getElementById('conn-status').classList.replace('bg-yellow-500','bg-red-500'); document.getElementById('conn-text').innerText="Offline"; showToast("Gagal mengambil data server","error"); });
        }

        function switchTab(t) {
            ['dashboard','input','list','print'].forEach(id=>document.getElementById('view-'+id).classList.add('hidden'));
            document.getElementById('view-'+t).classList.remove('hidden');
            ['dashboard','input','list'].forEach(id=>{ const b=document.getElementById('desk-nav-'+id); if(b) b.className=id===t?'px-5 py-2 rounded-lg text-sm font-bold bg-blue-50 text-blue-600 ring-1 ring-blue-100':'px-5 py-2 rounded-lg text-sm font-medium hover:bg-slate-50 text-slate-500'; });
            ['dashboard','input','list'].forEach(id=>{ const b=document.getElementById('mob-nav-'+id); if(b && id!=='input') { b.className=id===t?'flex flex-col items-center justify-center w-full h-full text-blue-600':'flex flex-col items-center justify-center w-full h-full text-slate-400'; b.querySelector('i').className=id===t?(id==='dashboard'?'ph ph-squares-four text-2xl mb-1 font-bold':'ph ph-list-dashes text-2xl mb-1 font-bold'):(id==='dashboard'?'ph ph-squares-four text-2xl mb-1':'ph ph-list-dashes text-2xl mb-1'); } });
            if(t==='print') switchDoc('voucher'); if(t==='list') renderTable(); if(t==='dashboard') updateDashboard();
        }
        function switchDoc(type) {
            const v=document.getElementById('print-voucher-container'), r=document.getElementById('print-receipt-container'), bV=document.getElementById('tab-voucher'), bR=document.getElementById('tab-receipt');
            if(type==='voucher') { v.style.display='block';v.classList.add('active-doc');r.style.display='none';r.classList.remove('active-doc'); bV.className='tab-btn active flex-1 px-6 py-2.5 rounded-lg text-sm font-bold transition-all'; bR.className='tab-btn inactive flex-1 px-6 py-2.5 rounded-lg text-sm font-bold transition-all'; } 
            else { v.style.display='none';v.classList.remove('active-doc');r.style.display='block';r.classList.add('active-doc'); bV.className='tab-btn inactive flex-1 px-6 py-2.5 rounded-lg text-sm font-bold transition-all'; bR.className='tab-btn active flex-1 px-6 py-2.5 rounded-lg text-sm font-bold transition-all'; }
        }

        function initForm() { document.getElementById('in-date').valueAsDate=new Date(); const d=new Date(); document.getElementById('dashboard-filter-month').value=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; items=[]; addMsg(); generateAutoID(); }
        function addMsg() { items.push({id:Date.now(),code:'',desc:'',amount:0}); renderRows(); }
        function delMsg(id) { if(items.length>1) items=items.filter(x=>x.id!==id); renderRows(); }
        function upMsg(id,k,v) { const i=items.find(x=>x.id===id); if(i){ i[k]=k==='amount'?parseFloat(v.replace(/\./g,''))||0:v; renderTotal(); } }
        
        function renderRows() { 
            document.getElementById('in-list').innerHTML=items.map(i=>`
                <tr class="group hover:bg-blue-50/50 transition">
                    <td class="py-2 pr-2 align-top"><input oninput="upMsg(${i.id},'code',this.value)" value="${i.code}" class="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Kode"></td>
                    <td class="py-2 pr-2 align-top"><input oninput="upMsg(${i.id},'desc',this.value)" value="${i.desc}" class="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Keterangan"></td>
                    <td class="py-2 pr-2 align-top"><input type="text" onkeyup="formatInputCurrency(this); upMsg(${i.id},'amount',this.value)" value="${i.amount ? new Intl.NumberFormat('id-ID').format(i.amount) : ''}" class="w-full text-right bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none font-mono" placeholder="0"></td>
                    <td class="py-2 text-center align-top pt-3"><button onclick="delMsg(${i.id})" class="text-slate-400 hover:text-red-500 transition"><i class="ph ph-trash text-lg"></i></button></td>
                </tr>`).join(''); 
            renderTotal(); 
        }
        
        function renderTotal() { const t=items.reduce((a,b)=>a+b.amount,0); document.getElementById('in-total').innerText=fmtRp(t); document.getElementById('in-terbilang').innerText=terbilang(t)+" Rupiah"; }
        function resetForm() { document.querySelectorAll('#view-input input').forEach(i=>i.value=''); document.getElementById('in-method').value='Cash'; initForm(); }
        function submitData() { const t=items.reduce((a,b)=>a+b.amount,0); if(t<=0) return showToast("Mohon isi nominal pembayaran","error"); const rec={ id:document.getElementById('in-no').value, date:document.getElementById('in-date').value, bank:document.getElementById('in-bank').value, rekening:document.getElementById('in-rek').value, bg:document.getElementById('in-bg').value, method:document.getElementById('in-method').value, paidTo:document.getElementById('in-paid').value, details:[...items] }; db.push(rec); document.getElementById('loading-overlay').classList.remove('hidden'); fetch(SCRIPT_URL, {method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify(rec)}).then(()=>{ showToast("Data Berhasil Disimpan!"); resetForm(); fetchCloudData(); switchTab('list'); }).catch(()=>{ showToast("Tersimpan Offline", "warning"); document.getElementById('loading-overlay').classList.add('hidden'); resetForm(); switchTab('list'); }); }
        
        function renderTable() {
            const q = document.getElementById('search').value.toLowerCase(); const flt = db.slice().reverse().filter(x => (x.id+x.paidTo).toLowerCase().includes(q));
            document.getElementById('data-desktop-body').innerHTML = flt.map(x => { const t = x.details.reduce((a,b)=>a+(b.amount||0),0); return `<tr class="hover:bg-slate-50 transition group"><td class="p-5 font-medium text-slate-700">${x.id}</td><td class="p-5 text-slate-500">${x.date}</td><td class="p-5 text-slate-700 font-medium">${x.paidTo}</td><td class="p-5 font-bold text-slate-800 font-mono">${fmtRp(t)}</td><td class="p-5 text-right"><button onclick="loadPrint('${x.id}')" class="text-slate-400 hover:text-blue-600 transition p-2 hover:bg-blue-50 rounded-lg"><i class="ph ph-printer text-xl"></i></button></td></tr>`; }).join('');
            document.getElementById('data-mobile-list').innerHTML = flt.map(x => { const t = x.details.reduce((a,b)=>a+(b.amount||0),0); return `<div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 active:scale-[0.98] transition-transform" onclick="loadPrint('${x.id}')"><div class="flex justify-between items-start mb-3"><span class="text-xs font-bold text-blue-600 bg-blue-50 px-2.5 py-1 rounded-md">${x.id}</span><span class="text-xs text-slate-400 font-medium">${x.date}</span></div><h3 class="font-bold text-slate-800 text-lg mb-1 leading-snug">${x.paidTo}</h3><div class="flex justify-between items-center mt-4 border-t border-slate-50 pt-3"><span class="font-bold text-slate-700 font-mono">${fmtRp(t)}</span><button class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-600"><i class="ph ph-printer text-lg"></i></button></div></div>`; }).join('');
        }

        function loadPrint(id) {
            const d=db.find(x=>x.id===id); if(!d) return;
            const t=d.details.reduce((a,b)=>a+(b.amount||0),0); const ter=terbilang(t)+" Rupiah";
            ['v-no','r-no'].forEach(i=>document.getElementById(i).innerText=d.id); ['v-date','r-date'].forEach(i=>document.getElementById(i).innerText=d.date); ['v-paid'].forEach(i=>document.getElementById(i).innerText=d.paidTo); ['v-total','r-total'].forEach(i=>document.getElementById(i).innerText=fmtRp(t)); ['v-terbilang','r-terbilang'].forEach(i=>document.getElementById(i).innerText=ter);
            document.getElementById('v-bank').innerText=d.bank; document.getElementById('v-rek').innerText=d.rekening; document.getElementById('v-bg').innerText=d.bg; document.getElementById('v-method').innerText=d.method;
            document.getElementById('v-rows').innerHTML = d.details.map(x=>`<tr><td class="border-r border-black p-2 text-center">${x.code}</td><td class="border-r border-black p-2">${x.desc}</td><td class="p-2 text-right font-mono">${fmtRp(x.amount)}</td></tr>`).join('') + `<tr><td class="border-r border-black h-6"></td><td class="border-r border-black"></td><td></td></tr>`.repeat(Math.max(0, 5-d.details.length));
            const rTable = document.getElementById('r-desc-table');
            rTable.innerHTML = d.details.map(x=>`<tr><td class="w-20 align-top py-1.5 font-mono text-slate-600 text-xs">${x.code}</td><td class="align-top py-1.5 text-justify pr-4 leading-snug">${x.desc}</td><td class="align-top py-1.5 text-right font-mono font-medium whitespace-nowrap">${fmtRp(x.amount)}</td></tr>`).join('');
            document.getElementById('modal-id-display').innerText=d.id; document.getElementById('modal-date').innerText=d.date; document.getElementById('modal-paid').innerText=d.paidTo; document.getElementById('modal-method').innerText=d.method; document.getElementById('modal-total').innerText=fmtRp(t);
            document.getElementById('modal-rows').innerHTML=d.details.map(x=>`<div class="flex justify-between items-center py-3"><div class="flex-1 pr-4"><div class="text-xs font-bold text-blue-500 mb-0.5 bg-blue-50 inline-block px-1.5 rounded">${x.code}</div><div class="text-sm text-slate-700 leading-snug">${x.desc}</div></div><div class="font-mono text-sm font-bold text-slate-800">${fmtRp(x.amount)}</div></div>`).join('');
            document.getElementById('modal-print-btn').onclick=function(){ closeDetail(); switchTab('print'); };
            switchTab('print');
        }

        function showDetailFromDash(id) { const d=db.find(x=>x.id===id); if(d) { loadPrint(id); document.getElementById('detail-modal').classList.remove('hidden'); } }
        function closeDetail() { document.getElementById('detail-modal').classList.add('hidden'); }
        function updateDashboard() { const m=document.getElementById('dashboard-filter-month').value; let tot=0, c=0; const recent=[]; const cats={}; db.forEach(x=>{ if(m&&!x.date.startsWith(m))return; const t=x.details.reduce((a,b)=>a+(b.amount||0),0); tot+=t; c++; recent.push({id:x.id,to:x.paidTo,d:x.date,t:t}); x.details.forEach(d=>{cats[d.code||'Lainnya']=(cats[d.code||'Lainnya']||0)+(d.amount||0);}); }); document.getElementById('stat-total-amount').innerText=fmtRp(tot); document.getElementById('stat-total-docs').innerText=c; document.getElementById('stat-avg-amount').innerText=c?fmtRp(tot/c):"Rp 0"; document.getElementById('recent-activity-list').innerHTML=recent.reverse().slice(0,5).map(x=>`<li onclick="showDetailFromDash('${x.id}')" class="flex justify-between items-center py-3 border-b border-slate-50 last:border-0 cursor-pointer hover:bg-slate-50 transition-colors rounded-xl px-3 group"><div><div class="font-bold text-slate-700 text-sm group-hover:text-blue-600 transition mb-0.5">${x.to}</div><div class="text-xs text-slate-400 font-medium">${x.d}</div></div><div class="text-right"><div class="font-bold text-slate-800 text-sm font-mono">${fmtRp(x.t)}</div><div class="text-[10px] text-blue-500 font-bold opacity-0 group-hover:opacity-100 transition transform translate-x-2 group-hover:translate-x-0">Detail <i class="ph ph-caret-right"></i></div></div></li>`).join('')||'<div class="flex flex-col items-center justify-center h-full text-slate-400 py-10"><i class="ph ph-tray text-4xl mb-2 opacity-50"></i><p class="text-xs">Belum ada transaksi</p></div>'; const ctx=document.getElementById('expenseChart').getContext('2d'); if(window.expenseChartObj)window.expenseChartObj.destroy(); window.expenseChartObj=new Chart(ctx,{type:'doughnut',data:{labels:Object.keys(cats),datasets:[{data:Object.values(cats),backgroundColor:['#3B82F6','#6366F1','#8B5CF6','#EC4899','#F43F5E','#F59E0B'],borderWidth:0,hoverOffset:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{usePointStyle:true,pointStyle:'circle',boxWidth:6,font:{size:11,family:'Inter'}}}},cutout:'75%'}}); }
        function resetDashboardFilter() { document.getElementById('dashboard-filter-month').value=''; updateDashboard(); }
        function fmtRp(n) { return new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0}).format(n); }
        function terbilang(n) { const a=Math.abs(n),b=['','Satu','Dua','Tiga','Empat','Lima','Enam','Tujuh','Delapan','Sembilan','Sepuluh','Sebelas']; if(a<12)return ' '+b[a]; if(a<20)return terbilang(a-10)+' Belas'; if(a<100)return terbilang(Math.floor(a/10))+' Puluh'+terbilang(a%10); if(a<200)return ' Seratus'+terbilang(a-100); if(a<1000)return terbilang(Math.floor(a/100))+' Ratus'+terbilang(a%100); if(a<2000)return ' Seribu'+terbilang(a-1000); if(a<1000000)return terbilang(Math.floor(a/1000))+' Ribu'+terbilang(a%1000); if(a<1000000000)return terbilang(Math.floor(a/1000000))+' Juta'+terbilang(a%1000000); return ''; }
    </script>
</body>
</html>

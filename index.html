<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Manajemen BDV - Adaro Karya Mandiri</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 100%;
            height: 300px;
            max-height: 300px;
        }

        /* Print Specific Styling */
        @media print {
            @page {
                size: A4; /* Default A4 */
                margin: 10mm;
            }
            body * { visibility: hidden; }
            
            /* Hanya tampilkan area print yang sedang aktif */
            #print-area, #print-area * { visibility: visible; }
            
            /* Sembunyikan elemen yang tidak punya class 'active-doc' saat print */
            .doc-container { display: none; }
            .doc-container.active-doc { 
                display: block !important; 
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }

            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                background-color: white;
            }
            .no-print { display: none !important; }
            
            .voucher-box {
                border: 2px solid #000;
                padding: 15px;
                font-family: 'Times New Roman', serif;
                background: white;
                margin-bottom: 0; /* Reset margin for single page */
                min-height: 90vh; /* Agar terlihat penuh di kertas jika perlu */
            }
            
            table, th, td {
                border-color: #000 !important;
            }
            
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
        
        #loading-overlay {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(2px);
        }

        /* Helper untuk switch tab di tampilan web */
        .tab-active {
            background-color: #2563EB; /* Blue-600 */
            color: white;
            border-color: #2563EB;
        }
        .tab-inactive {
            background-color: white;
            color: #475569; /* Slate-600 */
            border-color: #CBD5E1; /* Slate-300 */
        }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- Loading Indicator -->
    <div id="loading-overlay" class="hidden fixed inset-0 z-50 flex items-center justify-center flex-col">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
        <p class="text-blue-600 font-semibold">Menyimpan ke Google Sheets...</p>
    </div>

    <!-- Top Navigation -->
    <nav class="bg-white border-b border-slate-200 shadow-sm z-10 no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center gap-2">
                        <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center text-white font-bold">A</div>
                        <span class="font-bold text-xl tracking-tight text-slate-800">BDV Manager - Adaro Karya Mandiri</span>
                    </div>
                    <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                        <button onclick="switchTab('dashboard')" id="nav-dashboard" class="border-blue-500 text-gray-900 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-colors">
                            Dashboard
                        </button>
                        <button onclick="switchTab('input')" id="nav-input" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-colors">
                            Input Baru
                        </button>
                        <button onclick="switchTab('list')" id="nav-list" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-colors">
                            Data BDV
                        </button>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-1">
                        <span id="connection-status" class="h-2 w-2 rounded-full bg-red-500"></span>
                        <span class="text-xs text-slate-400" id="connection-text">Offline Mode</span>
                    </div>
                    <span class="text-sm text-slate-500 bg-slate-100 px-3 py-1 rounded-full">Tahun Anggaran 2025</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Container -->
    <main class="flex-1 overflow-y-auto bg-slate-50 p-4 sm:p-8 relative">
        
        <!-- SECTION 1: DASHBOARD -->
        <section id="view-dashboard" class="max-w-7xl mx-auto space-y-6 fade-in">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">Ringkasan Keuangan</h2>
                    <p class="text-slate-500 text-sm">Overview pengeluaran BDV real-time.</p>
                </div>
                <div class="flex items-center gap-2 bg-white p-2 rounded-lg border border-slate-200 shadow-sm">
                    <label for="dashboard-filter-month" class="text-sm font-medium text-slate-600">Periode:</label>
                    <input type="month" id="dashboard-filter-month" onchange="updateDashboard()" class="text-sm border-slate-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-slate-700 border px-2 py-1">
                    <button onclick="resetDashboardFilter()" class="text-xs text-blue-600 hover:text-blue-800 font-medium underline px-2 border-l border-slate-200 ml-1">
                        Reset (Semua)
                    </button>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white overflow-hidden shadow rounded-lg border border-slate-100">
                    <div class="px-4 py-5 sm:p-6">
                        <dt class="text-sm font-medium text-slate-500 truncate">Total Pengeluaran</dt>
                        <dd class="mt-1 text-3xl font-semibold text-blue-600" id="stat-total-amount">Rp 0</dd>
                    </div>
                </div>
                <div class="bg-white overflow-hidden shadow rounded-lg border border-slate-100">
                    <div class="px-4 py-5 sm:p-6">
                        <dt class="text-sm font-medium text-slate-500 truncate">Jumlah Dokumen BDV</dt>
                        <dd class="mt-1 text-3xl font-semibold text-slate-800" id="stat-total-docs">0</dd>
                    </div>
                </div>
                <div class="bg-white overflow-hidden shadow rounded-lg border border-slate-100">
                    <div class="px-4 py-5 sm:p-6">
                        <dt class="text-sm font-medium text-slate-500 truncate">Rata-rata per BDV</dt>
                        <dd class="mt-1 text-3xl font-semibold text-emerald-600" id="stat-avg-amount">Rp 0</dd>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white shadow rounded-lg p-6 border border-slate-100">
                    <h3 class="text-lg leading-6 font-medium text-slate-900 mb-4">Distribusi Pengeluaran per Kode Akun</h3>
                    <div class="chart-container mx-auto">
                        <canvas id="expenseChart"></canvas>
                    </div>
                </div>

                <div class="bg-white shadow rounded-lg p-6 border border-slate-100 flex flex-col">
                    <h3 class="text-lg leading-6 font-medium text-slate-900 mb-4">Aktivitas (Sesuai Filter)</h3>
                    <div class="flex-1 overflow-y-auto pr-2">
                        <ul id="recent-activity-list" class="divide-y divide-slate-200">
                            <!-- Populated by JS -->
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION 2: INPUT FORM -->
        <section id="view-input" class="hidden max-w-5xl mx-auto space-y-6">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">Buat BDV Baru</h2>
                    <p class="text-slate-500 text-sm">Isi form di bawah ini untuk mencatat pengeluaran baru.</p>
                </div>
            </div>

            <div class="bg-white shadow-lg rounded-xl overflow-hidden border border-slate-200">
                <div class="p-6 md:p-8 space-y-8">
                    <!-- Form fields here (same as before) -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label class="block text-sm font-medium text-slate-700">Nomor BDV</label><input type="text" id="input-no-bdv" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm border p-2" placeholder="Contoh: 09/BDV/KOPKAR/IX/2025"></div>
                        <div><label class="block text-sm font-medium text-slate-700">Tanggal</label><input type="date" id="input-date" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm border p-2"></div>
                        <div><label class="block text-sm font-medium text-slate-700">Bank & Rekening</label><div class="grid grid-cols-2 gap-2"><input type="text" id="input-bank" placeholder="Bank" class="mt-1 block w-full rounded border p-2"><input type="text" id="input-rekening" placeholder="No. Rekening" class="mt-1 block w-full rounded border p-2"></div></div>
                        <div><label class="block text-sm font-medium text-slate-700">Info Pembayaran</label><div class="grid grid-cols-2 gap-2"><input type="text" id="input-bg" placeholder="No BG / Cek" class="mt-1 block w-full rounded border p-2"><select id="input-method" class="mt-1 block w-full rounded border p-2"><option>Cash</option><option>Transfer</option><option>Cek</option></select></div></div>
                        <div class="md:col-span-2"><label class="block text-sm font-medium text-slate-700">Dibayar Kepada</label><input type="text" id="input-paid-to" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm border p-2" placeholder="Nama Penerima / Supplier"></div>
                    </div>
                    <hr class="border-slate-200">
                    <div>
                        <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-medium text-slate-900">Rincian Pembayaran</h3><button onclick="addLineItem()" class="px-3 py-1 text-xs font-medium rounded text-blue-700 bg-blue-100 hover:bg-blue-200">+ Tambah Baris</button></div>
                        <div class="overflow-x-auto"><table class="min-w-full divide-y divide-slate-200"><thead class="bg-slate-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Kode Per</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Keterangan</th><th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase">Jumlah (Rp)</th><th class="px-6 py-3"></th></tr></thead><tbody id="line-items-body" class="bg-white divide-y divide-slate-200"></tbody><tfoot class="bg-slate-50 font-bold"><tr><td colspan="2" class="px-6 py-3 text-right text-sm">Total:</td><td class="px-6 py-3 text-right text-sm text-blue-700" id="input-total-display">Rp 0</td><td></td></tr><tr><td colspan="4" class="px-6 py-2 text-right text-xs text-slate-500 italic" id="input-terbilang">Nol Rupiah</td></tr></tfoot></table></div>
                    </div>
                    <div class="flex justify-end gap-3 pt-4"><button onclick="clearForm()" class="px-4 py-2 border border-slate-300 rounded text-slate-700 bg-white hover:bg-slate-50">Reset</button><button onclick="saveBDV()" class="px-4 py-2 rounded text-white bg-blue-600 hover:bg-blue-700">Simpan BDV & Upload</button></div>
                </div>
            </div>
        </section>

        <!-- SECTION 3: DATA LIST -->
        <section id="view-list" class="hidden max-w-7xl mx-auto space-y-6">
            <div class="mb-6"><h2 class="text-2xl font-bold text-slate-800">Database BDV</h2><p class="text-slate-500 text-sm">Arsip seluruh voucher.</p></div>
            <div class="bg-white shadow overflow-hidden border border-slate-200 sm:rounded-lg">
                <div class="px-4 py-3 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                    <div class="w-full max-w-xs relative"><span class="absolute inset-y-0 left-0 pl-3 flex items-center">üîç</span><input id="search-input" onkeyup="filterTable()" class="block w-full bg-white py-2 pl-10 pr-3 border border-slate-300 rounded sm:text-sm" placeholder="Cari..."></div>
                    <div class="text-sm text-slate-500">Total: <span id="record-count" class="font-bold">0</span></div>
                </div>
                <div class="overflow-x-auto"><table class="min-w-full divide-y divide-slate-200"><thead class="bg-slate-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">No BDV</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Tanggal</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Penerima</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Total</th><th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase">Aksi</th></tr></thead><tbody id="bdv-table-body" class="bg-white divide-y divide-slate-200"></tbody></table></div>
            </div>
        </section>

        <!-- SECTION 4: PRINT PREVIEW (SPLIT MODE) -->
        <section id="view-print" class="hidden max-w-5xl mx-auto pb-10">
            <!-- Print Controls -->
            <div class="no-print mb-6 bg-white p-4 rounded-xl border border-slate-200 shadow-sm sticky top-4 z-20">
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                    <div class="flex gap-2 bg-slate-100 p-1 rounded-lg">
                        <button onclick="setPrintMode('voucher')" id="btn-mode-voucher" class="px-4 py-2 text-sm font-medium rounded-md transition-colors tab-active">
                            üìÑ Voucher BDV
                        </button>
                        <button onclick="setPrintMode('receipt')" id="btn-mode-receipt" class="px-4 py-2 text-sm font-medium rounded-md transition-colors tab-inactive">
                            üìù Tanda Terima
                        </button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="switchTab('list')" class="text-slate-600 hover:text-slate-900 flex items-center gap-2 px-3 py-2 rounded hover:bg-slate-50">
                            ‚Üê Kembali
                        </button>
                        <button onclick="window.print()" class="bg-blue-600 text-white px-6 py-2 rounded-md shadow hover:bg-blue-700 font-bold flex items-center gap-2">
                            üñ®Ô∏è Cetak Dokumen
                        </button>
                    </div>
                </div>
                <div class="mt-2 text-xs text-slate-500 text-center">
                    Pastikan kertas ukuran A4. Sistem akan mencetak dokumen yang sedang ditampilkan.
                </div>
            </div>

            <!-- PRINT CONTAINER START -->
            <div id="print-area" class="mx-auto" style="max-width: 210mm;">
                
                <!-- === CONTAINER 1: VOUCHER BDV === -->
                <div id="print-voucher-container" class="doc-container active-doc">
                    <div class="voucher-box relative">
                        <div class="flex justify-between items-start mb-4 border-b-2 border-black pb-2"><div><h1 class="text-xl font-bold uppercase tracking-wide">Bank Distribution Voucher</h1><p class="text-sm font-bold">Koperasi Karyawan Adaro Karya Mandiri</p></div><div class="text-right text-xs"><div class="grid grid-cols-[auto_1fr] gap-x-2"><span class="font-bold">NO:</span><span id="print-no-bdv" class="font-mono"></span><span class="font-bold">TGL:</span><span id="print-date"></span></div></div></div>
                        <div class="mb-3 text-xs font-serif"><div class="grid grid-cols-[100px_1fr] gap-y-1"><div class="font-bold">BANK:</div><div id="print-bank"></div><div class="font-bold">REKENING:</div><div id="print-rekening"></div><div class="font-bold">NO BG/CEK:</div><div id="print-bg"></div></div></div>
                        <div class="mb-4 border border-black p-3"><div class="grid grid-cols-[100px_1fr] gap-y-2 font-serif text-xs"><div class="font-bold pt-1">DIBAYAR KEPADA:</div><div id="print-paid-to" class="uppercase border-b border-dotted border-black pt-1"></div><div class="font-bold pt-1">JUMLAH:</div><div class="bg-gray-100 p-1 font-bold border border-gray-300 inline-block w-full italic" id="print-terbilang"></div><div class="font-bold pt-1">PEMBAYARAN:</div><div id="print-method" class="border-b border-dotted border-black pt-1"></div></div></div>
                        <div class="mb-4"><table class="w-full border-collapse border border-black text-xs font-serif"><thead class="bg-gray-100"><tr><th class="border border-black px-2 py-1 w-20">KODE PER</th><th class="border border-black px-2 py-1">KETERANGAN</th><th class="border border-black px-2 py-1 w-32 text-right">JUMLAH</th></tr></thead><tbody id="print-details-body"></tbody><tfoot><tr class="font-bold"><td colspan="2" class="border border-black px-2 py-1 text-right">TOTAL</td><td class="border border-black px-2 py-1 text-right" id="print-total-numeric"></td></tr></tfoot></table></div>
                        <div class="mt-8 grid grid-cols-5 gap-2 text-center text-[10px] font-serif"><div><p class="mb-10">Dibuat Oleh,</p><p class="font-bold border-t border-black pt-1 mx-auto w-11/12">Administrasi</p></div><div><p class="mb-10">Diperiksa Oleh,</p><p class="font-bold border-t border-black pt-1 mx-auto w-11/12">Staff Administrasi</p></div><div><p class="mb-10">Diketahui Oleh,</p><p class="font-bold border-t border-black pt-1 mx-auto w-11/12">Manager</p></div><div><p class="mb-10">Disetujui Oleh,</p><p class="font-bold border-t border-black pt-1 mx-auto w-11/12">Bendahara</p></div><div><p class="mb-10">Disetujui Oleh,</p><p class="font-bold border-t border-black pt-1 mx-auto w-11/12">Ketua</p></div></div>
                        <div class="absolute top-2 right-2 border border-black px-2 py-1 text-[10px] font-bold uppercase rotate-[-15deg] opacity-50">BANK COPY</div>
                    </div>
                </div>

                <!-- === CONTAINER 2: TANDA TERIMA / ARSIP === -->
                <div id="print-receipt-container" class="doc-container" style="display: none;">
                    <div class="voucher-box relative">
                        <div class="flex justify-between items-start mb-4 border-b-2 border-black pb-2"><div><h1 class="text-xl font-bold uppercase tracking-wide">TANDA TERIMA / ARSIP</h1><p class="text-xs font-bold">Koperasi Karyawan Adaro Karya Mandiri - Bukti Pengeluaran Kas/Bank</p></div><div class="text-right text-xs"><div class="grid grid-cols-[auto_1fr] gap-x-2"><span class="font-bold">REF BDV:</span><span id="print-copy-no-bdv" class="font-mono"></span><span class="font-bold">TGL:</span><span id="print-copy-date"></span></div></div></div>
                        <div class="p-4 border border-black mb-6 bg-slate-50">
                            <div class="grid grid-cols-[140px_20px_1fr] gap-y-2 font-serif text-sm">
                                <div class="font-bold">Telah Terima Dari</div><div class="text-center font-bold">:</div><div class="border-b border-black uppercase font-bold">KOPERASI KARYAWAN ADARO KARYA MANDIRI</div>
                                <div class="font-bold">Uang Sejumlah</div><div class="text-center font-bold">:</div><div class="border-b border-black italic bg-white px-2" id="print-copy-terbilang"></div>
                                <div class="font-bold">Guna Membayar</div><div class="text-center font-bold">:</div>
                                <!-- Dynamic Content Here -->
                                <div class="border-b border-black pb-2" id="print-copy-desc-container"></div>
                                <div class="font-bold text-lg mt-2">TOTAL</div><div class="text-center font-bold text-lg mt-2">:</div><div class="mt-2"><div class="border border-black bg-white font-bold text-lg px-4 py-1 inline-block min-w-[150px] text-right" id="print-copy-total">Rp 0</div></div>
                            </div>
                        </div>
                        <div class="flex justify-between items-end px-8 mt-10 font-serif text-sm"><div class="text-center w-48"><p class="mb-16">Mengetahui,</p><p class="font-bold border-t border-black pt-1 mx-auto w-40">Keuangan / Kasir</p></div><div class="text-center w-64"><p class="mb-2">................, ........................ 20...</p><p class="mb-12">Penerima,</p><p class="font-bold border-t border-black pt-1 mx-auto w-56 whitespace-nowrap">( ............................................ )</p></div></div>
                        <div class="absolute top-2 right-2 border border-black px-2 py-1 text-[10px] font-bold uppercase rotate-[-15deg] opacity-50">ARSIP / RECEIPT</div>
                    </div>
                </div>

            </div>
            <!-- PRINT CONTAINER END -->
        </section>

    </main>

    <!-- JavaScript Logic -->
    <script>
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzlyeOckoDbYpWGx09Y4JB4CGY1Eg_ksNpfDRF1anbuWlF4JYQYAJCOhQoXy9-kwOBMgw/exec'; 

        // --- Init & Connection ---
        if(GOOGLE_SCRIPT_URL.includes('/exec')) {
             document.getElementById('connection-status').classList.replace('bg-red-500', 'bg-green-500');
             document.getElementById('connection-text').innerText = "Connected to Sheets";
             document.getElementById('connection-text').classList.replace('text-slate-400', 'text-green-600');
        }

        let bdvDatabase = [];

        function initForm() {
            document.getElementById('input-date').valueAsDate = new Date();
            const today = new Date();
            document.getElementById('dashboard-filter-month').value = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
            currentLineItems = [];
            addLineItem();
        }

        // --- Navigation ---
        function switchTab(tabName) {
            ['dashboard', 'input', 'list', 'print'].forEach(id => document.getElementById('view-' + id).classList.add('hidden'));
            document.getElementById('view-' + tabName).classList.remove('hidden');
            // Reset print mode to default (voucher) when entering print tab
            if(tabName === 'print') setPrintMode('voucher');
            
            ['dashboard', 'input', 'list'].forEach(id => {
                const btn = document.getElementById('nav-' + id);
                if(btn) {
                    btn.className = id === tabName 
                        ? 'border-blue-500 text-gray-900 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-colors'
                        : 'border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-colors';
                }
            });
            if(tabName === 'dashboard') updateDashboard();
            if(tabName === 'list') renderListTable();
        }

        // --- PRINT MODE LOGIC (NEW) ---
        function setPrintMode(mode) {
            const voucherDiv = document.getElementById('print-voucher-container');
            const receiptDiv = document.getElementById('print-receipt-container');
            const btnVoucher = document.getElementById('btn-mode-voucher');
            const btnReceipt = document.getElementById('btn-mode-receipt');

            if (mode === 'voucher') {
                voucherDiv.style.display = 'block';
                voucherDiv.classList.add('active-doc');
                receiptDiv.style.display = 'none';
                receiptDiv.classList.remove('active-doc');
                
                btnVoucher.className = 'px-4 py-2 text-sm font-medium rounded-md transition-colors tab-active';
                btnReceipt.className = 'px-4 py-2 text-sm font-medium rounded-md transition-colors tab-inactive';
            } else {
                voucherDiv.style.display = 'none';
                voucherDiv.classList.remove('active-doc');
                receiptDiv.style.display = 'block';
                receiptDiv.classList.add('active-doc');

                btnVoucher.className = 'px-4 py-2 text-sm font-medium rounded-md transition-colors tab-inactive';
                btnReceipt.className = 'px-4 py-2 text-sm font-medium rounded-md transition-colors tab-active';
            }
        }

        // --- Form Logic ---
        let currentLineItems = [];
        function addLineItem() {
            const id = Date.now();
            currentLineItems.push({ id: id, code: '', desc: '', amount: 0 });
            renderLineItems();
        }
        function removeLineItem(id) {
            if(currentLineItems.length <= 1) return;
            currentLineItems = currentLineItems.filter(item => item.id !== id);
            renderLineItems();
        }
        function updateLineItem(id, field, value) {
            const item = currentLineItems.find(x => x.id === id);
            if(item) { item[field] = field === 'amount' ? parseFloat(value) || 0 : value; calculateFormTotal(); }
        }
        function renderLineItems() {
            const tbody = document.getElementById('line-items-body');
            tbody.innerHTML = '';
            currentLineItems.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-2"><input type="text" value="${item.code}" onchange="updateLineItem(${item.id}, 'code', this.value)" class="w-full border-b outline-none text-sm" placeholder="Ex: 2-200"></td>
                    <td class="px-6 py-2"><input type="text" value="${item.desc}" onchange="updateLineItem(${item.id}, 'desc', this.value)" class="w-full border-b outline-none text-sm" placeholder="Keterangan"></td>
                    <td class="px-6 py-2"><input type="number" value="${item.amount === 0 ? '' : item.amount}" onkeyup="updateLineItem(${item.id}, 'amount', this.value)" class="w-full text-right border-b outline-none text-sm" placeholder="0"></td>
                    <td class="px-6 py-2 text-center"><button onclick="removeLineItem(${item.id})" class="text-red-500 font-bold">√ó</button></td>`;
                tbody.appendChild(tr);
            });
            calculateFormTotal();
        }
        function calculateFormTotal() {
            const total = currentLineItems.reduce((acc, curr) => acc + curr.amount, 0);
            document.getElementById('input-total-display').innerText = formatRupiah(total);
            document.getElementById('input-terbilang').innerText = getTerbilangComplete(total);
            return total;
        }
        function clearForm() {
            document.getElementById('input-no-bdv').value = '';
            document.getElementById('input-bank').value = '';
            document.getElementById('input-rekening').value = '';
            document.getElementById('input-bg').value = '';
            document.getElementById('input-paid-to').value = '';
            initForm();
        }

        // --- Save Logic ---
        function saveBDV() {
            const total = currentLineItems.reduce((acc, curr) => acc + curr.amount, 0);
            if(total <= 0) { alert("Mohon isi nominal pembayaran."); return; }

            const newRecord = {
                id: document.getElementById('input-no-bdv').value || "DRAFT/" + Date.now(),
                date: document.getElementById('input-date').value,
                bank: document.getElementById('input-bank').value,
                rekening: document.getElementById('input-rekening').value,
                bg: document.getElementById('input-bg').value,
                method: document.getElementById('input-method').value,
                paidTo: document.getElementById('input-paid-to').value,
                details: currentLineItems.map(item => ({...item}))
            };

            bdvDatabase.push(newRecord);

            if (GOOGLE_SCRIPT_URL.includes('/exec')) {
                document.getElementById('loading-overlay').classList.remove('hidden');
                
                fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newRecord)
                })
                .then(() => {
                    document.getElementById('loading-overlay').classList.add('hidden');
                    alert("Sukses! Data tersimpan.");
                    finalizeSave();
                })
                .catch(error => {
                    console.error(error);
                    document.getElementById('loading-overlay').classList.add('hidden');
                    alert("Gagal koneksi ke Google Sheet. Data tersimpan lokal.");
                    finalizeSave();
                });
            } else {
                alert("Data Tersimpan (Offline).");
                finalizeSave();
            }
        }

        function finalizeSave() {
            clearForm();
            switchTab('list');
        }

        // --- Helpers ---
        function formatRupiah(num) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(num); }
        function getTerbilangComplete(num) {
            if(num===0) return "Nol Rupiah";
            return terbilang(num) + " Rupiah";
        }
        function terbilang(nilai) {
            const angka = Math.abs(nilai);
            const baca = ['', 'Satu', 'Dua', 'Tiga', 'Empat', 'Lima', 'Enam', 'Tujuh', 'Delapan', 'Sembilan', 'Sepuluh', 'Sebelas'];
            let text = '';
            if (angka < 12) text = ' ' + baca[angka];
            else if (angka < 20) text = terbilang(angka - 10) + ' Belas';
            else if (angka < 100) text = terbilang(Math.floor(angka / 10)) + ' Puluh' + terbilang(angka % 10);
            else if (angka < 200) text = ' Seratus' + terbilang(angka - 100);
            else if (angka < 1000) text = terbilang(Math.floor(angka / 100)) + ' Ratus' + terbilang(angka % 100);
            else if (angka < 2000) text = ' Seribu' + terbilang(angka - 1000);
            else if (angka < 1000000) text = terbilang(Math.floor(angka / 1000)) + ' Ribu' + terbilang(angka % 1000);
            else if (angka < 1000000000) text = terbilang(Math.floor(angka / 1000000)) + ' Juta' + terbilang(angka % 1000000);
            return text;
        }

        // --- List & Print Data ---
        function renderListTable() {
            const filterText = document.getElementById('search-input').value.toLowerCase();
            const tbody = document.getElementById('bdv-table-body');
            tbody.innerHTML = '';
            
            const displayData = [...bdvDatabase].reverse().filter(item => {
                const searchStr = (item.id + item.paidTo + item.date).toLowerCase();
                return searchStr.includes(filterText);
            });

            document.getElementById('record-count').innerText = displayData.length;

            displayData.forEach(item => {
                const total = item.details.reduce((acc, curr) => acc + curr.amount, 0);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${item.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${item.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${item.paidTo}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 font-bold">${formatRupiah(total)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="loadPrintView('${item.id}')" class="text-blue-600 hover:text-blue-900 bg-blue-100 p-2 rounded-full">üñ®Ô∏è</button>
                    </td>`;
                tbody.appendChild(tr);
            });
        }
        function filterTable() { renderListTable(); }

        function loadPrintView(id) {
            const record = bdvDatabase.find(x => x.id === id);
            if(!record) return;
            const total = record.details.reduce((acc, curr) => acc + curr.amount, 0);
            const totalStr = formatRupiah(total);
            const terbilangStr = getTerbilangComplete(total);

            // Fill VOUCHER
            document.getElementById('print-no-bdv').innerText = record.id;
            document.getElementById('print-date').innerText = record.date;
            document.getElementById('print-bank').innerText = record.bank || "-";
            document.getElementById('print-rekening').innerText = record.rekening || "-";
            document.getElementById('print-bg').innerText = record.bg || "-";
            document.getElementById('print-paid-to').innerText = record.paidTo;
            document.getElementById('print-terbilang').innerText = terbilangStr;
            document.getElementById('print-method').innerText = record.method;
            document.getElementById('print-total-numeric').innerText = totalStr;

            const tbody = document.getElementById('print-details-body');
            tbody.innerHTML = '';
            record.details.forEach(detail => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="border border-black px-2 py-1 text-center">${detail.code}</td><td class="border border-black px-2 py-1">${detail.desc}</td><td class="border border-black px-2 py-1 text-right">${formatRupiah(detail.amount)}</td>`;
                tbody.appendChild(tr);
            });
            // Fill Empty Rows in Voucher
            const emptyRows = Math.max(0, 6 - record.details.length);
            for(let i=0; i<emptyRows; i++) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="border border-black px-2 py-1">&nbsp;</td><td class="border border-black px-2 py-1">&nbsp;</td><td class="border border-black px-2 py-1">&nbsp;</td>`;
                tbody.appendChild(tr);
            }

            // Fill RECEIPT (Multi-Item)
            document.getElementById('print-copy-no-bdv').innerText = record.id;
            document.getElementById('print-copy-date').innerText = record.date;
            document.getElementById('print-copy-terbilang').innerText = terbilangStr;
            document.getElementById('print-copy-total').innerText = totalStr;
            
            // Build Multi-Line List for Receipt Description
            let copyDescHtml = '<table class="w-full text-xs border-collapse">';
            record.details.forEach(det => {
                copyDescHtml += `
                    <tr>
                        <td class="align-top pr-2 font-mono text-[10px] pt-1" style="width: 40px">${det.code}</td>
                        <td class="align-top pt-1">${det.desc}</td>
                        <td class="align-top text-right pt-1 font-mono" style="width: 100px">Rp ${formatRupiah(det.amount)}</td>
                    </tr>
                `;
            });
            copyDescHtml += '</table>';
            document.getElementById('print-copy-desc-container').innerHTML = copyDescHtml;

            switchTab('print');
        }

        // --- Dashboard ---
        let expenseChart = null;
        function updateDashboard() {
            const filterValue = document.getElementById('dashboard-filter-month').value;
            let totalAmount = 0;
            let docCount = 0;
            let codeBreakdown = {};
            const filteredDocs = [];

            bdvDatabase.forEach(doc => {
                if (filterValue && !doc.date.startsWith(filterValue)) return;
                filteredDocs.push(doc);
                docCount++;
                doc.details.forEach(det => {
                    totalAmount += det.amount;
                    if(det.code) codeBreakdown[det.code] = (codeBreakdown[det.code] || 0) + det.amount;
                    else codeBreakdown["Lainnya"] = (codeBreakdown["Lainnya"] || 0) + det.amount;
                });
            });

            document.getElementById('stat-total-amount').innerText = formatRupiah(totalAmount);
            document.getElementById('stat-total-docs').innerText = docCount;
            document.getElementById('stat-avg-amount').innerText = docCount ? formatRupiah(totalAmount / docCount) : "Rp 0";

            const list = document.getElementById('recent-activity-list');
            list.innerHTML = '';
            const sortedDocs = [...filteredDocs].sort((a,b) => new Date(b.date) - new Date(a.date));
            
            if(sortedDocs.length === 0) list.innerHTML = '<li class="py-4 text-center text-slate-500 italic text-sm">Tidak ada transaksi.</li>';
            else {
                sortedDocs.slice(0, 5).forEach(doc => {
                    const li = document.createElement('li');
                    li.className = "py-4 flex justify-between";
                    li.innerHTML = `<div><p class="text-sm font-medium text-slate-900">${doc.paidTo}</p><p class="text-xs text-slate-500">${doc.date}</p></div><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">${formatRupiah(doc.details.reduce((a,b)=>a+b.amount,0))}</span>`;
                    list.appendChild(li);
                });
            }

            const ctx = document.getElementById('expenseChart').getContext('2d');
            if(expenseChart) expenseChart.destroy();
            expenseChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(codeBreakdown),
                    datasets: [{
                        data: Object.values(codeBreakdown),
                        backgroundColor: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#6366F1', '#8B5CF6'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }
        function resetDashboardFilter() {
            document.getElementById('dashboard-filter-month').value = '';
            updateDashboard();
        }

        window.onload = function() {
            initForm();
            updateDashboard();
            switchTab('dashboard');
        };
    </script>
</body>
</html>

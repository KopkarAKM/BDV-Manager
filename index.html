<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem BDV - Adaro Karya Mandiri</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 100%;
            height: 300px;
            max-height: 300px;
        }

        /* Tab Styles */
        .tab-btn.active {
            background-color: #2563EB; /* Blue-600 */
            color: white;
            border-color: #2563EB;
        }
        .tab-btn.inactive {
            background-color: white;
            color: #475569; /* Slate-600 */
            border-color: #CBD5E1; /* Slate-300 */
        }

        /* Print Specific Styling */
        @media print {
            @page {
                size: A4; 
                margin: 10mm;
            }
            body * { visibility: hidden; }
            
            /* Hanya tampilkan area print yang sedang aktif */
            #print-area, #print-area * { visibility: visible; }
            
            /* Logic tampilan dokumen saat print */
            .doc-container { display: none; }
            .doc-container.active-doc { 
                display: block !important; 
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }

            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                background-color: white;
            }
            .no-print { display: none !important; }
            
            .voucher-box {
                border: 2px solid #000;
                padding: 15px;
                font-family: 'Times New Roman', serif;
                background: white;
                margin-bottom: 0; 
                min-height: 90vh; 
            }
            
            table, th, td {
                border-color: #000 !important;
            }
            
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
        
        #loading-overlay {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(2px);
        }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- Loading Indicator -->
    <div id="loading-overlay" class="hidden fixed inset-0 z-50 flex items-center justify-center flex-col">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
        <p id="loading-text" class="text-blue-600 font-bold text-lg">Menghubungkan ke Database...</p>
    </div>

    <!-- Top Navigation -->
    <nav class="bg-white border-b border-slate-200 shadow-sm z-10 no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center gap-2">
                        <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center text-white font-bold">A</div>
                        <span class="font-bold text-xl tracking-tight text-slate-800">BDV Adaro KM</span>
                    </div>
                    <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                        <button onclick="switchTab('dashboard')" id="nav-dashboard" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-colors">
                            Dashboard
                        </button>
                        <button onclick="switchTab('input')" id="nav-input" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-colors">
                            Input Baru
                        </button>
                        <button onclick="switchTab('list')" id="nav-list" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-colors">
                            Data BDV
                        </button>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-1">
                        <span id="connection-status" class="h-2 w-2 rounded-full bg-yellow-500"></span>
                        <span class="text-xs text-slate-400" id="connection-text">Menunggu Data...</span>
                    </div>
                    <span class="text-sm text-slate-500 bg-slate-100 px-3 py-1 rounded-full">Tahun 2025</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Container -->
    <main class="flex-1 overflow-y-auto bg-slate-50 p-4 sm:p-8 relative">
        
        <!-- SECTION 1: DASHBOARD -->
        <section id="view-dashboard" class="max-w-7xl mx-auto space-y-6 fade-in">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">Ringkasan Keuangan</h2>
                    <p class="text-slate-500 text-sm">Overview pengeluaran BDV real-time.</p>
                </div>
                <div class="flex items-center gap-2 bg-white p-2 rounded-lg border border-slate-200 shadow-sm">
                    <label for="dashboard-filter-month" class="text-sm font-medium text-slate-600">Periode:</label>
                    <input type="month" id="dashboard-filter-month" onchange="updateDashboard()" class="text-sm border-slate-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-slate-700 border px-2 py-1">
                    <button onclick="resetDashboardFilter()" class="text-xs text-blue-600 hover:text-blue-800 font-medium underline px-2 border-l border-slate-200 ml-1">
                        Reset (Semua)
                    </button>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white overflow-hidden shadow rounded-lg border border-slate-100">
                    <div class="px-4 py-5 sm:p-6">
                        <dt class="text-sm font-medium text-slate-500 truncate">Total Pengeluaran</dt>
                        <dd class="mt-1 text-3xl font-semibold text-blue-600" id="stat-total-amount">Rp 0</dd>
                    </div>
                </div>
                <div class="bg-white overflow-hidden shadow rounded-lg border border-slate-100">
                    <div class="px-4 py-5 sm:p-6">
                        <dt class="text-sm font-medium text-slate-500 truncate">Jumlah Dokumen BDV</dt>
                        <dd class="mt-1 text-3xl font-semibold text-slate-800" id="stat-total-docs">0</dd>
                    </div>
                </div>
                <div class="bg-white overflow-hidden shadow rounded-lg border border-slate-100">
                    <div class="px-4 py-5 sm:p-6">
                        <dt class="text-sm font-medium text-slate-500 truncate">Rata-rata per BDV</dt>
                        <dd class="mt-1 text-3xl font-semibold text-emerald-600" id="stat-avg-amount">Rp 0</dd>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white shadow rounded-lg p-6 border border-slate-100">
                    <h3 class="text-lg leading-6 font-medium text-slate-900 mb-4">Distribusi Pengeluaran</h3>
                    <div class="chart-container mx-auto">
                        <canvas id="expenseChart"></canvas>
                    </div>
                </div>

                <div class="bg-white shadow rounded-lg p-6 border border-slate-100 flex flex-col">
                    <h3 class="text-lg leading-6 font-medium text-slate-900 mb-4">Aktivitas (Sesuai Filter)</h3>
                    <div class="flex-1 overflow-y-auto pr-2">
                        <ul id="recent-activity-list" class="divide-y divide-slate-200">
                            <!-- Populated by JS -->
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION 2: INPUT FORM -->
        <section id="view-input" class="hidden max-w-5xl mx-auto space-y-6">
            <div class="bg-white rounded-xl border shadow-sm p-6 space-y-6">
                <h2 class="text-xl font-bold">Input BDV Baru</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="text-xs font-bold text-gray-700">No BDV</label><input id="in-no" type="text" class="w-full border rounded p-2 mt-1" placeholder="Nomor..."></div>
                    <div><label class="text-xs font-bold text-gray-700">Tanggal</label><input id="in-date" type="date" class="w-full border rounded p-2 mt-1"></div>
                    <div><label class="text-xs font-bold text-gray-700">Bank</label><input id="in-bank" type="text" class="w-full border rounded p-2 mt-1" placeholder="Mandiri/BCA..."></div>
                    <div><label class="text-xs font-bold text-gray-700">Rekening</label><input id="in-rek" type="text" class="w-full border rounded p-2 mt-1" placeholder="Nomor Rek..."></div>
                    <div><label class="text-xs font-bold text-gray-700">No BG/Cek</label><input id="in-bg" type="text" class="w-full border rounded p-2 mt-1"></div>
                    <div><label class="text-xs font-bold text-gray-700">Metode</label><select id="in-method" class="w-full border rounded p-2 mt-1"><option>Cash</option><option>Transfer</option><option>Cek</option></select></div>
                    <div class="md:col-span-2"><label class="text-xs font-bold text-gray-700">Dibayar Kepada</label><input id="in-paid" type="text" class="w-full border rounded p-2 mt-1" placeholder="Nama Penerima / Supplier"></div>
                </div>
                
                <div class="border-t pt-4">
                    <div class="flex justify-between mb-2"><h3 class="font-bold">Rincian Pembayaran</h3><button onclick="addMsg()" class="text-blue-600 text-xs font-bold hover:bg-blue-50 px-2 py-1 rounded">+ Tambah Baris</button></div>
                    <table class="w-full text-sm"><thead class="bg-slate-50 text-left"><tr><th class="p-2">Kode</th><th class="p-2">Keterangan</th><th class="p-2 text-right">Jumlah</th><th class="p-2"></th></tr></thead><tbody id="in-list"></tbody></table>
                    <div class="flex justify-between items-center mt-4 bg-slate-50 p-2 rounded"><span class="font-bold">Total:</span><span class="font-bold text-blue-600 text-lg" id="in-total">Rp 0</span></div>
                    <div class="text-right text-xs italic text-gray-500 mt-1" id="in-terbilang">Nol Rupiah</div>
                </div>

                <div class="flex justify-end gap-3 border-t pt-4">
                    <button onclick="resetForm()" class="px-4 py-2 border rounded hover:bg-slate-50 font-medium">Reset</button>
                    <button onclick="submitData()" class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-bold shadow transition-colors">Simpan & Upload</button>
                </div>
            </div>
        </section>

        <!-- SECTION 3: LIST DATA -->
        <section id="view-list" class="hidden max-w-7xl mx-auto space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">Data Tersimpan</h2>
                <div class="flex gap-2">
                    <button onclick="fetchCloudData()" class="px-3 py-1 bg-green-50 text-green-700 border border-green-200 rounded text-sm hover:bg-green-100 font-medium flex items-center gap-1">
                        üîÑ Refresh Data
                    </button>
                    <input id="search" onkeyup="renderTable()" placeholder="Cari..." class="border rounded p-2 text-sm w-40">
                </div>
            </div>
            <div class="bg-white rounded border shadow overflow-hidden">
                <table class="w-full text-sm text-left"><thead class="bg-slate-50 border-b"><tr><th class="p-3">No BDV</th><th class="p-3">Tanggal</th><th class="p-3">Penerima</th><th class="p-3">Total</th><th class="p-3 text-right">Aksi</th></tr></thead><tbody id="data-body"></tbody></table>
            </div>
        </section>

        <!-- SECTION 4: PRINT PREVIEW (TERPISAH & LENGKAP) -->
        <section id="view-print" class="hidden max-w-5xl mx-auto pb-10">
            <!-- Print Controls -->
            <div class="no-print sticky top-4 z-20 bg-white p-4 rounded-xl border shadow-lg mb-6">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex bg-slate-100 p-1 rounded-lg w-full md:w-auto">
                        <button onclick="switchDoc('voucher')" id="tab-voucher" class="tab-btn active flex-1 px-6 py-2 rounded-md text-sm font-bold transition-all">üìÑ Voucher BDV</button>
                        <button onclick="switchDoc('receipt')" id="tab-receipt" class="tab-btn inactive flex-1 px-6 py-2 rounded-md text-sm font-bold transition-all">üìù Tanda Terima</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="switchTab('list')" class="px-4 py-2 border rounded hover:bg-slate-50 text-sm">Kembali</button>
                        <button onclick="window.print()" class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-bold text-sm shadow flex items-center gap-2">
                            üñ®Ô∏è Cetak
                        </button>
                    </div>
                </div>
                <div class="mt-2 text-xs text-slate-500 text-center">
                    Pilih tab di atas untuk menentukan dokumen yang ingin dicetak.
                </div>
            </div>

            <div id="print-area" class="mx-auto" style="max-width: 210mm;">
                
                <!-- CONTAINER 1: VOUCHER BDV -->
                <div id="print-voucher-container" class="doc-container active-doc">
                    <div class="voucher-box relative">
                        <div class="flex justify-between items-start mb-4 border-b-2 border-black pb-2"><div><h1 class="text-xl font-bold uppercase tracking-wide">Bank Distribution Voucher</h1><p class="text-sm font-bold">Koperasi Karyawan Adaro Karya Mandiri</p></div><div class="text-right text-xs"><div class="grid grid-cols-[auto_1fr] gap-x-2"><span class="font-bold">NO:</span><span id="v-no" class="font-mono"></span><span class="font-bold">TGL:</span><span id="v-date"></span></div></div></div>
                        <div class="mb-3 text-xs font-serif"><div class="grid grid-cols-[100px_1fr] gap-y-1"><div class="font-bold">BANK:</div><div id="v-bank"></div><div class="font-bold">REKENING:</div><div id="v-rek"></div><div class="font-bold">NO BG/CEK:</div><div id="v-bg"></div></div></div>
                        <div class="mb-4 border border-black p-3"><div class="grid grid-cols-[100px_1fr] gap-y-2 font-serif text-xs"><div class="font-bold pt-1">KEPADA:</div><div id="v-paid" class="uppercase border-b border-dotted border-black pt-1"></div><div class="font-bold pt-1">JUMLAH:</div><div id="v-terbilang" class="bg-gray-100 p-1 font-bold border border-gray-300 inline-block w-full italic"></div><div class="font-bold pt-1">METODE:</div><div id="v-method" class="border-b border-dotted border-black pt-1"></div></div></div>
                        <div class="mb-4"><table class="w-full border-collapse border border-black text-xs font-serif"><thead class="bg-gray-100"><tr><th class="border border-black px-2 py-1 w-20">KODE PER</th><th class="border border-black px-2 py-1">KETERANGAN</th><th class="border border-black px-2 py-1 w-32 text-right">JUMLAH</th></tr></thead><tbody id="v-rows"></tbody><tfoot><tr class="font-bold"><td colspan="2" class="border border-black px-2 py-1 text-right">TOTAL</td><td class="border border-black px-2 py-1 text-right" id="v-total"></td></tr></tfoot></table></div>
                        <div class="mt-8 grid grid-cols-5 gap-2 text-center text-[10px] font-serif"><div><p class="mb-10">Dibuat Oleh,</p><p class="font-bold border-t border-black pt-1 mx-auto w-11/12">Administrasi</p></div><div><p class="mb-10">Diperiksa Oleh,</p><p class="font-bold border-t border-black pt-1 mx-auto w-11/12">Staff Administrasi</p></div><div><p class="mb-10">Diketahui Oleh,</p><p class="font-bold border-t border-black pt-1 mx-auto w-11/12">Manager</p></div><div><p class="mb-10">Disetujui Oleh,</p><p class="font-bold border-t border-black pt-1 mx-auto w-11/12">Bendahara</p></div><div><p class="mb-10">Disetujui Oleh,</p><p class="font-bold border-t border-black pt-1 mx-auto w-11/12">Ketua</p></div></div>
                        <div class="absolute top-2 right-2 border border-black px-2 py-1 text-[10px] font-bold uppercase rotate-[-15deg] opacity-50">BANK COPY</div>
                    </div>
                </div>

                <!-- CONTAINER 2: TANDA TERIMA / ARSIP -->
                <div id="print-receipt-container" class="doc-container" style="display: none;">
                    <div class="voucher-box relative">
                        <div class="flex justify-between items-start mb-4 border-b-2 border-black pb-2"><div><h1 class="text-xl font-bold uppercase tracking-wide">TANDA TERIMA / ARSIP</h1><p class="text-xs font-bold">Bukti Pengeluaran Kas/Bank</p></div><div class="text-right text-xs"><div class="grid grid-cols-[auto_1fr] gap-x-2"><span class="font-bold">REF:</span><span id="r-no" class="font-mono"></span><span class="font-bold">TGL:</span><span id="r-date"></span></div></div></div>
                        <div class="p-4 border border-black mb-6 bg-slate-50">
                            <div class="grid grid-cols-[140px_20px_1fr] gap-y-2 font-serif text-sm">
                                <div class="font-bold">Telah Terima Dari</div><div class="text-center font-bold">:</div><div class="border-b border-black uppercase font-bold">KOPERASI KARYAWAN ADARO KARYA MANDIRI</div>
                                <div class="font-bold">Uang Sejumlah</div><div class="text-center font-bold">:</div><div class="border-b border-black italic bg-white px-2" id="r-terbilang"></div>
                                <div class="font-bold">Guna Membayar</div><div class="text-center font-bold">:</div><div class="border-b border-black pb-2 bg-white px-2" id="r-desc-box"></div>
                                <div class="font-bold text-lg mt-2">TOTAL</div><div class="text-center font-bold text-lg mt-2">:</div><div class="mt-2"><div class="border border-black bg-white font-bold text-lg px-4 py-1 inline-block min-w-[150px] text-right" id="r-total">Rp 0</div></div>
                            </div>
                        </div>
                        <div class="flex justify-between items-end px-8 mt-10 font-serif text-sm"><div class="text-center w-48"><p class="mb-16">Mengetahui,</p><p class="font-bold border-t border-black pt-1 mx-auto w-40">Keuangan / Kasir</p></div><div class="text-center w-64"><p class="mb-2">................, ........................ 20...</p><p class="mb-12">Penerima,</p><p class="font-bold border-t border-black pt-1 mx-auto w-56 whitespace-nowrap">( ............................................ )</p></div></div>
                        <div class="absolute top-2 right-2 border border-black px-2 py-1 text-[10px] font-bold uppercase rotate-[-15deg] opacity-50">ARSIP / RECEIPT</div>
                    </div>
                </div>

            </div>
        </section>
    </main>

    <script>
        // CONFIG
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw5vngrzgb1vB33UIjv8kNy6OTsuZbVC5z4eL-CMG6DJ7HBXvY_NFHc03nqTs3hj1mm1Q/exec'; 

        // STATE
        let db = [];
        let items = [];

        // INIT
        window.onload = () => {
            initForm();
            if(SCRIPT_URL.includes('/exec')) fetchCloudData();
        };

        // FETCH DATA (GET)
        function fetchCloudData() {
            document.getElementById('loading-text').innerText = "Mengambil Data...";
            document.getElementById('loading-overlay').classList.remove('hidden');
            
            fetch(SCRIPT_URL)
            .then(res => res.json())
            .then(data => {
                db = data;
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('connection-status').classList.replace('bg-yellow-500','bg-green-500');
                document.getElementById('connection-text').innerText = "Tersinkron";
                renderTable();
                updateDashboard();
            })
            .catch(e => {
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('connection-status').classList.replace('bg-yellow-500','bg-red-500');
                document.getElementById('connection-text').innerText = "Gagal Sync";
                alert("Gagal mengambil data. Pastikan script sudah dideploy ulang sebagai New Version.");
            });
        }

        // NAVIGATION
        function switchTab(t) {
            ['dashboard','input','list','print'].forEach(id => document.getElementById('view-'+id).classList.add('hidden'));
            document.getElementById('view-'+t).classList.remove('hidden');
            
            ['dashboard','input','list'].forEach(id => {
                const btn = document.getElementById('nav-'+id);
                if(btn) btn.className = id===t ? 'border-blue-500 text-gray-900 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-colors' : 'border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-colors';
            });

            if(t === 'print') switchDoc('voucher'); 
            if(t === 'list') renderTable();
            if(t === 'dashboard') updateDashboard();
        }

        function switchDoc(type) {
            const v = document.getElementById('print-voucher-container');
            const r = document.getElementById('print-receipt-container');
            const btV = document.getElementById('tab-voucher');
            const btR = document.getElementById('tab-receipt');

            if(type === 'voucher') {
                v.style.display = 'block'; v.classList.add('active-doc');
                r.style.display = 'none'; r.classList.remove('active-doc');
                btV.className = 'tab-btn active flex-1 px-6 py-2 rounded-md text-sm font-bold transition-all';
                btR.className = 'tab-btn inactive flex-1 px-6 py-2 rounded-md text-sm font-bold transition-all';
            } else {
                v.style.display = 'none'; v.classList.remove('active-doc');
                r.style.display = 'block'; r.classList.add('active-doc');
                btV.className = 'tab-btn inactive flex-1 px-6 py-2 rounded-md text-sm font-bold transition-all';
                btR.className = 'tab-btn active flex-1 px-6 py-2 rounded-md text-sm font-bold transition-all';
            }
        }

        // INPUT LOGIC
        function initForm() {
            document.getElementById('in-date').valueAsDate = new Date();
            const d = new Date();
            document.getElementById('dashboard-filter-month').value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
            items = []; addMsg();
        }
        function addMsg() { items.push({id:Date.now(), code:'', desc:'', amount:0}); renderRows(); }
        function delMsg(id) { if(items.length > 1) items = items.filter(x => x.id !== id); renderRows(); }
        function upMsg(id, k, v) { const i = items.find(x => x.id === id); if(i) { i[k] = k==='amount'? (parseFloat(v)||0) : v; renderTotal(); } }
        function renderRows() {
            const h = items.map(i => `<tr class="border-b"><td class="p-1"><input oninput="upMsg(${i.id},'code',this.value)" value="${i.code}" class="w-full outline-none" placeholder="Kode"></td><td class="p-1"><input oninput="upMsg(${i.id},'desc',this.value)" value="${i.desc}" class="w-full outline-none" placeholder="Ket..."></td><td class="p-1"><input type="number" oninput="upMsg(${i.id},'amount',this.value)" value="${i.amount||''}" class="w-full text-right outline-none" placeholder="0"></td><td class="p-1 text-center"><button onclick="delMsg(${i.id})" class="text-red-500 font-bold">√ó</button></td></tr>`).join('');
            document.getElementById('in-list').innerHTML = h; renderTotal();
        }
        function renderTotal() { const t = items.reduce((a,b)=>a+b.amount,0); document.getElementById('in-total').innerText = fmtRp(t); document.getElementById('in-terbilang').innerText = terbilang(t) + " Rupiah"; }
        function resetForm() { 
            document.querySelectorAll('#view-input input').forEach(i => i.value='');
            document.getElementById('in-method').value='Cash';
            initForm(); 
        }

        // SAVE LOGIC (POST)
        function submitData() {
            const t = items.reduce((a,b)=>a+b.amount,0);
            if(t <= 0) return alert("Isi jumlah dulu!");

            const rec = {
                id: document.getElementById('in-no').value || "DRAFT-"+Date.now(),
                date: document.getElementById('in-date').value,
                bank: document.getElementById('in-bank').value,
                rekening: document.getElementById('in-rek').value,
                bg: document.getElementById('in-bg').value,
                method: document.getElementById('in-method').value,
                paidTo: document.getElementById('in-paid').value,
                details: [...items]
            };

            // Optimistic update
            db.push(rec);

            if(SCRIPT_URL.includes('/exec')) {
                document.getElementById('loading-text').innerText = "Menyimpan...";
                document.getElementById('loading-overlay').classList.remove('hidden');
                
                fetch(SCRIPT_URL, {
                    method: 'POST', mode: 'no-cors',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(rec)
                }).then(()=>{
                    document.getElementById('loading-overlay').classList.add('hidden');
                    alert("Tersimpan!"); resetForm(); fetchCloudData(); switchTab('list');
                }).catch(e=>{
                    document.getElementById('loading-overlay').classList.add('hidden');
                    alert("Tersimpan Offline (Gagal koneksi)."); resetForm(); switchTab('list');
                });
            } else {
                alert("Tersimpan Offline."); resetForm(); switchTab('list');
            }
        }

        // RENDER LIST
        function renderTable() {
            const q = document.getElementById('search').value.toLowerCase();
            const flt = db.slice().reverse().filter(x => (x.id+x.paidTo).toLowerCase().includes(q));
            document.getElementById('data-body').innerHTML = flt.map(x => {
                const tot = x.details.reduce((a,b)=>a+(b.amount||0),0);
                return `<tr class="border-b hover:bg-slate-50"><td class="p-3 font-medium">${x.id}</td><td class="p-3">${x.date}</td><td class="p-3">${x.paidTo}</td><td class="p-3 font-bold">${fmtRp(tot)}</td><td class="p-3 text-right"><button onclick="loadPrint('${x.id}')" class="text-blue-600 bg-blue-50 hover:bg-blue-100 px-3 py-1 rounded font-medium">Print</button></td></tr>`;
            }).join('');
        }

        // PRINT LOAD
        function loadPrint(id) {
            const d = db.find(x => x.id === id); if(!d) return;
            const tot = d.details.reduce((a,b)=>a+(b.amount||0),0); const ter = terbilang(tot) + " Rupiah";

            // VOUCHER FIELDS
            document.getElementById('v-no').innerText = d.id;
            document.getElementById('v-date').innerText = d.date;
            document.getElementById('v-bank').innerText = d.bank || "-";
            document.getElementById('v-rek').innerText = d.rekening || "-";
            document.getElementById('v-bg').innerText = d.bg || "-";
            document.getElementById('v-paid').innerText = d.paidTo;
            document.getElementById('v-terbilang').innerText = ter;
            document.getElementById('v-method').innerText = d.method;
            document.getElementById('v-total').innerText = fmtRp(tot);
            
            const vRows = d.details.map(x => `<tr><td class="border-r border-black p-1 text-center">${x.code}</td><td class="border-r border-black p-1">${x.desc}</td><td class="p-1 text-right">${fmtRp(x.amount)}</td></tr>`).join('');
            document.getElementById('v-rows').innerHTML = vRows + `<tr><td class="border-r border-black h-4"></td><td class="border-r border-black"></td><td></td></tr>`.repeat(Math.max(0, 5-d.details.length));

            // RECEIPT FIELDS
            document.getElementById('r-no').innerText = d.id;
            document.getElementById('r-date').innerText = d.date;
            document.getElementById('r-terbilang').innerText = ter;
            document.getElementById('r-total').innerText = fmtRp(tot);
            
            const rRows = d.details.map(x => `<div class="flex justify-between text-xs mb-1 border-b border-dotted pb-1 last:border-0"><span class="w-16 font-mono font-bold">${x.code}</span><span class="flex-1 px-2">${x.desc}</span><span class="font-mono">${fmtRp(x.amount)}</span></div>`).join('');
            document.getElementById('r-desc-box').innerHTML = rRows;

            switchTab('print');
        }

        // DASHBOARD
        function updateDashboard() {
            const m = document.getElementById('dashboard-filter-month').value;
            let tot=0, c=0; const recent=[];
            db.forEach(x=>{
                if(m && !x.date.startsWith(m)) return;
                const t=x.details.reduce((a,b)=>a+(b.amount||0),0); tot+=t; c++;
                recent.push({to:x.paidTo,d:x.date,t:t});
            });
            document.getElementById('stat-total-amount').innerText = fmtRp(tot);
            document.getElementById('stat-total-docs').innerText = c;
            document.getElementById('stat-avg-amount').innerText = c?fmtRp(tot/c):"Rp 0";
            
            const list = recent.reverse().slice(0,5).map(x=>`<li class="flex justify-between py-2 border-b last:border-0"><div><div class="font-bold text-slate-700">${x.to}</div><div class="text-xs text-gray-400">${x.d}</div></div><div class="font-bold text-blue-600">${fmtRp(x.t)}</div></li>`).join('') || '<li class="text-center text-gray-400 py-4 italic">Tidak ada transaksi</li>';
            document.getElementById('recent-activity-list').innerHTML = list;
        }
        function resetDashboardFilter() { document.getElementById('dashboard-filter-month').value = ''; updateDashboard(); }

        // UTILS
        function fmtRp(n) { return new Intl.NumberFormat('id-ID', {style:'currency', currency:'IDR', maximumFractionDigits:0}).format(n); }
        function terbilang(n) { const a=Math.abs(n), b=['','Satu','Dua','Tiga','Empat','Lima','Enam','Tujuh','Delapan','Sembilan','Sepuluh','Sebelas']; if(a<12)return ' '+b[a]; if(a<20)return terbilang(a-10)+' Belas'; if(a<100)return terbilang(Math.floor(a/10))+' Puluh'+terbilang(a%10); if(a<200)return ' Seratus'+terbilang(a-100); if(a<1000)return terbilang(Math.floor(a/100))+' Ratus'+terbilang(a%100); if(a<2000)return ' Seribu'+terbilang(a-1000); if(a<1000000)return terbilang(Math.floor(a/1000))+' Ribu'+terbilang(a%1000); if(a<1000000000)return terbilang(Math.floor(a/1000000))+' Juta'+terbilang(a%1000000); return ''; }
    </script>
</body>
</html>
